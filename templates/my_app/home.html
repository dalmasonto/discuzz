{% extends 'base.html' %} {% load static %} {% block content %}
<div class="jumbotron home">
    <div class="row mt-15">
        <div class="col-md-3 col-sm-12">
            <h3 class="text-center"> Welcome to the discussion forum, {{ user.username }} </h3>
            <p class="text-lead">For more info about discuzz, goto
                <a class="about" href="{% url 'about' %}">About DISCUZZ</a>
            </p>
            <div id="carouselId" class="carousel slide" data-ride="carousel">
                <ol class="carousel-indicators">
                    <li data-target="#carouselId" data-slide-to="0" class="active"></li>
                    <li data-target="#carouselId" data-slide-to="1"></li>
                    <li data-target="#carouselId" data-slide-to="2"></li>
                </ol>
                <div class="carousel-inner" role="listbox">
                    <div class="carousel-item active">
                        <img src="{% static 'images/ideashare.png' %}" alt="First slide">
                        <div class="carousel-caption d-none d-md-block">
                            <h6>Learn to share with others</h6>
                            <p>Enhance you capacity</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'images/ideashare.png' %}" alt="Second slide">
                        <div class="carousel-caption d-none d-md-block">
                            <h6>Learn to share with others</h6>
                            <p>Enhance you capacity</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'images/ideashare.png' %}" alt="Third slide">
                        <div class="carousel-caption d-none d-md-block">
                            <h6>Learn to share with others</h6>
                            <p>Enhance you capacity</p>
                        </div>
                    </div>
                </div>
                <a class="carousel-control-prev" href="#carouselId" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselId" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>


            <div class="login_form_improve">
                <h4 class="text-center">Create new topic</h4>
                <!-- {% for message in messages %}
                <p class="text-success text-danger">{{ message }}</p>
                {% endfor %} -->
                <form method="POST" action="/api/create/topic/homepage/" id="topic_creation_form">
                    {% csrf_token %}
                    <fieldset>
                        <div class="form-group col-md-12 inputBox response-topic-creation">
                            <!-- <p class="response-msg text-center">Some msg</p> -->
                        </div>
                        <div class="form-row input">
                            <div class="form-group col-md-12 inputBox">
                                <label for="uid">Topic</label>
                                <input type="text" class="" name="topic" id="uid" required placeholder="Topic">
                            </div>
                            <div class="form-group col-md-12 inputBox">
                                <label for="uid">Subtopic</label>
                                <input type="text" class="" name="subtopic" id="uid" required placeholder="Subtopic">
                            </div>
                            <div class="form-group col-md-12 inputBox">
                                <input type="submit" name="" value="Send">
                            </div>
                        </div>
                    </fieldset>
                </form>

            </div>

        </div>


        <div class="col-md-5 col-sm-12">
            <h3 id="titler" class="text-center"> Currently running discussions</h3>
            <!-- <span class="click">(Click to join)</span> -->
            <hr>
            <small class="float-left click"> (Click to join) </small>
            <small class="float-right"> brought to you by, 
            <i>
                <small>Shamaldas&copy;</small>
            </i>
            </small>
            <div class="queries">
                <!-- This div holds all the queries from the api -->
                <div class="spinner">
                    <div>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
            <div class="d-row">
                <!-- This div will hold the pagination buttons -->
                <!-- <button type="button" class="btn btn-warning float-left">Page 1 &raquo;</button>
                <button type="button" class="btn btn-warning float-right">&laquo;Page 2</button> -->
            </div>
            <!-- {% for discussion in discussions %}
            <a href="/discuzz/{{discussion.discussionCode}}" id="home-link">
                <div class="card" title="{{ discussion.discussionCode }}">
                    <div class="card-header">
                        <div class="card-title">{{ discussion.topic }}, {{ discussion.subtopic }}</div>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-info"> {{ discussion.description }}</p>
                        <p class="card-text"> Question: {{ discussion.question }} </p>
                        <p class="card-text"> The discussion code is: <span class="code">{{ discussion.discussionCode }}</span></p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><span class="float-left">Replies: {{ all_replies.count }}</span> <span class="float-right">by {{ discussion.admin }} </span></p>
                    </div>
                </div>
            </a>
            {% endfor %} -->
        </div>


        <div class="col-md-4 col-sm-12">
            <div class="row">
                <div class="col">
                    <h3 class="text-center">Improve our site</h3>
                    <div class="login_form_improve">
                        <h4 class="text-center">Send us email</h4>
                        <!-- {% for message in messages %}
                        <p class="text-success text-danger">{{ message }}</p>
                        {% endfor %} -->
                        <form method="POST" action="/api/messageUs/" id="send_us_message_form">
                            {% csrf_token %}
                            <fieldset>
                                <div class="form-group col-md-12 inputBox response-message-us">
                                    <!-- <p class="response-msg text-center">Some msg</p> -->
                                </div>
                                <div class="form-row input">
                                    <div class="form-group col-md-12 inputBox">
                                        <label for="uid">Email</label>
                                        <input type="email" class="" name="email" id="uid" required placeholder="d@gmail.com">
                                    </div>
                                    <div class="form-group col-md-12 inputBox">
                                        <label for="pwd">Message</label>
                                        <textarea name="updatemsg" id="reply" class="inputBox " accesskey="r" rows="5" cols="40" placeholder="Write message" required></textarea>
                                    </div>
                                    <div class="form-group col-md-12 inputBox">
                                        <input type="submit" name="" value="Send">
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                        <script>
                        </script>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>
<script>
    // Call the LoadQueries function onwindow load so as to fille the page with the required data
    window.onload = setTimeout(() => {
        LoadQueries(1, 5);
    }, 3000);

    // The button row
    const btnRow = document.querySelector('.d-row');
    const queriesEl = document.querySelector(".queries");

    const topic_creation_form = document.querySelector('#topic_creation_form');
    const topic_creation_div = document.querySelector('.response-topic-creation')

    const send_us_message_form = document.querySelector('#send_us_message_form');
    const msg_us_div = document.querySelector('.response-message-us');

    function clear_errors() {
        topic_creation_div.innerHTML = '';
        msg_us_div.innerHTML = '';
    }


    topic_creation_form.addEventListener('submit', handleCreateTopicForm);
    send_us_message_form.addEventListener('submit', handleMessageUsForm);

    const clearParentEls = () => {
        // function to clear the parents that hold the queries and the next and prev pages
        btnRow.innerHTML = '';
        queriesEl.innerHTML = '';
    };


    /* Adding an event handler to btnRow to check what is clicked and if clicked on the button, get the button and the data-gotot attribute */
    btnRow.addEventListener('click', (e) => {
        var btn = e.target.closest('.btn');
        if (btn) {
            const goToPage = parseInt(btn.dataset.goto, 10);
            LoadQueries(goToPage);
            console.log('the target go to page is', goToPage);
        }
    });


    //Create the buttons depending on the page
    const createBtn = (page, type, float) => `
            <button type="button" class="btn btn-warning ${float}" data-goto="${type === 'prev' ? page -1 : page + 1}">
                Page ${type === 'prev' ? page -1 : page + 1} ${type === 'prev' ? '&laquo;' : '&raquo;'}
            </button>
    `;


    //Render the buttons relevantly depending on the page and also the content
    const renderButtons = (page, numResults, resPerPage) => {
        const pages = Math.ceil(numResults / resPerPage);
        let button;

        if (page === 1 && pages > 1) {
            // Button to go next only
            button = createBtn(page, 'next', 'float-right');
        } else if (page < pages) {
            //Both buttons
            button = `
                ${createBtn(page, 'prev', 'float-left')}
                ${createBtn(page, 'next', 'float-right')}
            `;
        } else if (page === pages && pages > 1) {
            // Button to go back
            button = createBtn(page, 'prev', 'float-left');
        }
        btnRow.insertAdjacentHTML('afterbegin', button);
    };


    // The function to make each a tag in the queries div
    function queryTagRender(discussion) {
        const newA = `
        <a href="/discuzz/${discussion.discussionCode}" id="home-link">
            <div class="card" title="${discussion.discussionCode}">
                <div class="card-header">
                    <div class="card-title">${discussion.topic }, ${discussion.subtopic }</div>
                </div>
                <div class="card-body">
                    <p class="card-text text-info"> ${discussion.description }</p>
                    <p class="card-text"> Question: ${discussion.question } </p>
                    <p class="card-text"> The discussion code is: <span class="code">${discussion.discussionCode }</span></p>
                </div>
                <div class="card-footer">
                    <p class="card-text"><span class="float-left">Replies: {{ all_replies.count }}</span> <span class="float-right">by ${discussion.admin }</span></p>
                </div>
            </div>
        </a>
        `;
        queriesEl.insertAdjacentHTML("beforeEnd", newA);
    }

    // The function to call for the list depending on the page and load form the API 
    function LoadQueries(page = 1, resultsPerPage = 5) {
        var listed_queries = [];

        var page = page;
        var resultsPerPage = resultsPerPage;
        var start = (page - 1) * resultsPerPage;
        var end = page * resultsPerPage;

        const xhr = new XMLHttpRequest();
        const url = "/api/all_discussions/";
        const method = "GET";
        const responseType = "json";
        xhr.responseType = responseType;
        xhr.method = method;
        xhr.open(method, url);
        xhr.onload = () => {

                const serverResponse = xhr.response;
                var listed_queries = serverResponse.response;
                // console.log('The start is', start);
                // console.log('the end is', end);
                clearParentEls();
                listed_queries.slice(start, end).forEach(queryTagRender);
                renderButtons(page, listed_queries.length, resultsPerPage);

            }
            // Send the request
        xhr.send();
    }

    function handleMessageUsForm(event) {
        event.preventDefault();
        const myForm = event.target;
        const myFormData = new FormData(myForm);
        const url = myForm.getAttribute('action');
        const method = myForm.getAttribute('method');

        const xhr = new XMLHttpRequest();
        xhr.open(method, url);
        xhr.onload = () => {
            const serverResponse = xhr.response;
            const response_ = JSON.parse(serverResponse);
            clear_errors();
            myForm.reset();
            console.log('THE RESPONSE IS', response_);
            responseDisplay(msg_us_div, response_.response_msg, response_.response_type);
        };
        xhr.send(myFormData);
    }

    function handleCreateTopicForm(event) {
        event.preventDefault();
        const myForm = event.target;
        const myFormData = new FormData(myForm);
        const url = myForm.getAttribute('action');
        const method = myForm.getAttribute('method');

        const xhr = new XMLHttpRequest();
        xhr.open(method, url);
        xhr.onload = () => {
            const serverResponse = xhr.response;
            const response_ = JSON.parse(serverResponse);
            clear_errors();
            myForm.reset();
            console.log('THE RESPONSE IS', response_);
            responseDisplay(topic_creation_div, response_.response_msg, response_.response_type);
        };
        xhr.send(myFormData);
    }

    const responseDisplay = (parentEl, messsage, type) => {
        const response = `
                <p class="response-msg text-center text-${type}">${messsage}</p>
            `;

        parentEl.insertAdjacentHTML('beforeEnd', response);
    };
</script>
<script type="text/javascript" src="{% static 'jquery.js' %}">
</script>
</div>
{% endblock %}